<HTML>
<HEAD>
<TITLE>Stream Converter Interface</TITLE>
</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000"
LINK="#0000EE" VLINK="#551A8B" ALINK="#FF0000"
MARGINHEIGHT=0 MARGINWIDTH=0>

<MAP NAME="banner">
<AREA SHAPE=RECT COORDS="300,11,558,44" HREF="http://www.mozilla.org/">
</MAP>

<TABLE BORDER=0 CELLPADDING=0 CELLSPACING=0 WIDTH="100%">
<TR><TD BGCOLOR="#000000" VALIGN=TOP ROWSPAN=2><IMG
SRC="../images/mozilla-banner.gif"
ALT="" BORDER=0 USEMAP="#banner"
WIDTH=600 HEIGHT=58 VSPACE=0 HSPACE=0></TD></TR></TABLE>
<TABLE BORDER=0 CELLPADDING=0 CELLSPACING=0 WIDTH="100%">

<TR>


<TD BGCOLOR="#000000" VALIGN=TOP ALIGN=RIGHT><IMG ALT=""
SRC="../images/bit.gif"
WIDTH=4 HEIGHT=16 HSPACE=0 VSPACE=0></TD>



<TD BGCOLOR="#DDDDDD" VALIGN=TOP><IMG ALT=""
SRC="../images/curve1.gif"
WIDTH=16 HEIGHT=16 HSPACE=0 VSPACE=0></TD>


<TD BGCOLOR="#DDDDDD" VALIGN=TOP ALIGN=RIGHT><IMG ALT=""
SRC="../images/curve3.gif"
WIDTH=16 HEIGHT=16 HSPACE=0 VSPACE=0></TD>


<TD BGCOLOR="#000000" VALIGN=TOP><IMG ALT=""
SRC="../images/bit.gif"
WIDTH=4 HEIGHT=16 HSPACE=0 VSPACE=0></TD>


<TD VALIGN=TOP><IMG ALT=""
SRC="../images/curve1.gif"
WIDTH=16 HEIGHT=16 HSPACE=0 VSPACE=0></TD>


<TD VALIGN=TOP ALIGN=RIGHT>
</TD>


<TD VALIGN=TOP ALIGN=RIGHT><IMG ALT=""
SRC="../images/curve3.gif"
WIDTH=16 HEIGHT=16 HSPACE=0 VSPACE=0></TD>


<TD BGCOLOR="#000000" VALIGN=TOP><IMG ALT=""
SRC="../images/bit.gif"
WIDTH=4 HEIGHT=16 HSPACE=0 VSPACE=0></TD>

</TR>


<TR>

<TD BGCOLOR="#000000" VALIGN=TOP ALIGN=RIGHT><IMG ALT=""
SRC="../images/bit.gif"
WIDTH=4 HEIGHT=16 HSPACE=0 VSPACE=0></TD>


<TD BGCOLOR="#DDDDDD" VALIGN=TOP COLSPAN=2>

<TABLE CELLPADDING=0 CELLSPACING=3 BORDER=0>
<TR><TD VALIGN=TOP><IMG SRC="../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=19><A HREF="..//"><B> The Mozilla<BR>Organization</B></A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../mission.html"> Our Mission</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../about.html"> Who We Are</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../get-involved.html"> Getting Involved</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../community.html"> Community</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../advocacy.html"> Editorials</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../news.html"> What's New</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../newsbot/"> Newsbot</A></TD></TR>
<TR><TD NOWRAP VALIGN=TOP COLSPAN=20><B></B></TD></TR>
<TR><TD VALIGN=TOP><IMG SRC="../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=19><A HREF="../development.html"><B> Development</B></A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../roadmap.html"> Roadmap</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../owners.html"> Module Owners</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../blue-sky/"> Blue Sky</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../projects/"> Projects</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../status/"> Status</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../tools.html"> Tools</A></TD></TR>
<TR><TD NOWRAP VALIGN=TOP COLSPAN=20><B></B></TD></TR>
<TR><TD VALIGN=TOP><IMG SRC="../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=19><A HREF="../products.html"><B> Products</B></A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../source.html"> Source Code</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../binaries.html"> Binaries</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../docs/"> Documentation</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../NPL/"> License Terms</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../bugs/"> Bug Reports</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../quality/"> Quality</A></TD></TR>
<TR><TD NOWRAP VALIGN=TOP COLSPAN=20><B></B></TD></TR>
<TR><TD VALIGN=TOP><IMG SRC="../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=19><A HREF="../search.html"><B> Search</B></A></TD></TR>
<TR><TD VALIGN=TOP><IMG SRC="../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=19><A HREF="../feedback.html"><B> Feedback</B></A></TD></TR>
</TABLE>
</TD>


<TD BGCOLOR="#000000" VALIGN=TOP ALIGN=RIGHT><IMG ALT=""
SRC="../images/bit.gif"
WIDTH=4 HEIGHT=16 HSPACE=0 VSPACE=0></TD>


<TD VALIGN=TOP ALIGN=RIGHT>
</TD>


<TD VALIGN=TOP>




   
   
<!-- created by rhp -->



<center><b><font color="#000000"><font size=+2>Stream Converter Interface</font></font></b>
<br><b><font color="#000000"><font size=+2>(nsIStreamConverter)</font></font></b>
<br><b><font color="#000000">by Richard H. Pizzarro &lt;<a href="mailto:rhp@netscape.com">rhp@netscape.com</a>></font></b></center>
<b><font color="#000000"><font size=+1>Contents</font></font></b>
<ul>
<li>
<a href="#OVER">Overview</a></li>

<li>
<a href="#CALLFLOW">Example Call Flow</a></li>

<li>
<a href="#API">API</a></li>

<ul>&nbsp;</ul>
</ul>
<a NAME="OVER"></a><b><font color="#000000"><font size=+1>Overview</font></font></b>
<br><font color="#000000">An general purpose interface needs to be defined
to allow the integration of stream converters to the Gecko architecture
(in particular, netlib). A prime example of a stream converter is the libmime
component that currently resides in the Communicator client. libmime is
responsible for conversion of "message/RFC822" streams to various formats
(such as HTML for display). Currently, libmime is a statically linked library
that exposes a C API for use by libnet, but this should take the form of
an XP-COM interface that would allow for external modules to be added,
updated, etc. as development proceeds.</font>
<ul>&nbsp;</ul>
<a NAME="CALLFLOW"></a><b><font color="#000000"><font size=+1>Example Call
Flow</font></font></b>
<br><font color="#000000">Before we get into the details of any API, we
should discuss the general call flow of what we are trying to accomplish
with this stream converter interface. In our example, we will use the IMAP
Protocol handler and the operation will be rendering an MHTML message retrieved
from an IMAP server.</font>
<br>&nbsp;
<ul>
<li>
<font color="#000000">The user clicks on a message listed in the Messenger
FE. This message resides on an IMAP server so a URL to retrieve the server
will be fired by the FE</font></li>

<li>
<font color="#000000">The netlib/IMAP protocol handler starts the process
of downloading the message from the IMAP server</font></li>

<li>
<font color="#000000">The MIME type for the message is identified to be
"message/rfc822". Since the user wishes to display this message in an HTML
display window, the protocol handler needs to identify and initialize a
stream converter than can convert an "message/rfc822" stream to HTML.</font></li>

<li>
<font color="#000000">The IMAP protocol handler would query the Stream
Converter Manager which had a table of all the available stream converter
factories and the format conversions that they support. (Note: this discovery
process and the Stream Converter Manager is not explained in this document).</font></li>

<li>
<font color="#000000">The IMAP Protocol Handler would create and instance
of the RFC822-HTML converter</font></li>

<li>
<font color="#000000">The IMAP Protocol Handler would set the following
on the converter:</font></li>

<ul>
<li>
<font color="#000000">Output stream for the RFC822-HTML converter. This
is the stream where converted output will be written to after processing
by the stream converter.</font></li>

<li>
<font color="#000000">The output listener on the RFC822-HTML converter.
Some explanation is necessary on why we should set the output listener.
Consider the following case:</font></li>

<br>&nbsp;
<ul>
<table>
<tr>
<td BGCOLOR="#FFCC99">
<center><b><font face="Arial,Helvetica">IMAP PROTOCOL HANDLER</font></b>
<br><i><font face="Arial,Helvetica">feeds RFC822 data to the stream converter</font></i></center>
</td>

<td BGCOLOR="#FFFFCC">
<center><b><font face="Arial,Helvetica">RFC822 to HTML STREAM CONVERTER</font></b>
<br><i><font face="Arial,Helvetica">processes RFC822 data and returns an
HTML stream</font></i></center>
</td>
</tr>

<tr>
<td BGCOLOR="#99FF99">
<center><b><font face="Arial,Helvetica">HTML RENDERING ENGINE</font></b>
<br><i><font face="Arial,Helvetica">displays the HTML stream&nbsp;</font></i></center>
</td>

<td></td>
</tr>
</table>
</ul>
<font color="#000000">In this situation, it would be nice to have the flexibility
for both of the following options:</font>
<ul>
<li>
<font color="#000000">Have the converted HTML stream be passed back to
the IMAP Protocol handler and from there, it will be fed into the HTML
rendering engine</font></li>

<li>
<font color="#000000">Have the stream converter directly feed the data
into the HTML rendering engine without any processing required by the IMAP
protocol handler</font></li>
</ul>
<font color="#000000">For option #2, we will need the stream converter
to notify the output listener via the OnDataAvailable() method. In order
to do this, the RFC822-HTML converter will need to know the output listener
for processed data.</font></ul>

<li>
<font color="#000000">After creating the RFC822-HTML converter, the OnStartBinding()
method will be called to notify the stream converter that the data flow
is starting</font></li>

<li>
<font color="#000000">The RFC822-HTML->OnDataAvailable() method will be
called to notify the stream converter of new data available for conversion.</font></li>

<li>
<font color="#000000">The RFC822-HTML converter will process the data and
write the output to the previously set output stream</font></li>

<li>
<font color="#000000">IF the IMAP Protocol handler set the output listener
on the converter, the RFC822-HTML converter will be responsible for calling
the OnDataAvailable() method on these listeners. If not, the converter
will return</font></li>

<li>
<font color="#000000">The IMAP Protocol Handler would continue receiving
data from the network socket and notifying the stream converter until the
end of the stream is reached.</font></li>

<li>
<font color="#000000">When the stream is completed (or interrupted) the
IMAP Protocol Handler will call the StopBinding() method for the stream
converter and the this will complete the operation</font><br>
<BR></li>
</ul>
<a NAME="API"></a><b><font color="#000000"><font size=+1>API</font></font></b>
<br>Now that we have an understanding of the general call flow for a stream
converter, we should start discussing the XP-COM interface for these modules.
First, we will define a general <b><font face="Arial,Helvetica">nsIStreamConverter</font></b>
interface that will be subclassed with unique ClassID's for all of the
various stream converters. For example, <b><font face="Arial,Helvetica">nsIStreamConverter
</font></b>is
the general class definition for a stream converter, but
<b><font face="Arial,Helvetica">nsIRFC822toHTMLStreamConverter</font></b>
which supports the <b><font face="Arial,Helvetica">nsIStreamConverter</font></b>
interface would be the specific RFC822 to HTML stream converter. (Note:
A registry of converters and the formats they support would need to be
set on a machine and managed by the Stream Converter Manager for use at
runtime)
<p>With all of this in mind, lets look at a definition of the general class
and a specific RFC822 to HTML stream converter.
<br>&nbsp;
<br>&nbsp;
<table COLS=1 WIDTH="100%" BGCOLOR="#FFCC99" >
<tr>
<td>
<center><b><font face="Arial,Helvetica">nsIStreamConverter.h</font></b></center>
</td>
</tr>
</table>

<p><tt>#ifndef nsIStreamConverter_h_</tt>
<br><tt>#define nsIStreamConverter_h_</tt>
<p><tt>#include "nsIStreamListener.h"</tt>
<br><tt>#include "nsIOutputStream.h"</tt>
<p><tt>// {C9CDF8E5-95FA-11d2-8807-00805F5A1FB8}</tt>
<br><tt>#define NS_ISTREAM_CONVERTER_IID \</tt>
<br><tt>&nbsp;&nbsp; { 0xc9cdf8e5, 0x95fa, 0x11d2,&nbsp;&nbsp;&nbsp; \</tt>
<br><tt>&nbsp;&nbsp; { 0x88, 0x7, 0x0, 0x80, 0x5f, 0x5a, 0x1f, 0xb8 } };</tt>
<p><tt>class nsIStreamConverter : public nsIStreamListener {</tt>
<br><tt>public:</tt>
<br><tt>&nbsp;&nbsp;&nbsp; //</tt>
<br><tt>&nbsp;&nbsp;&nbsp; // This is the output stream where the stream
converter will write processed data after</tt>
<br><tt>&nbsp;&nbsp;&nbsp; // conversion.</tt>
<br><tt>&nbsp;&nbsp;&nbsp; //</tt>
<br><tt>&nbsp;&nbsp;&nbsp; NS_IMETHOD SetOutputStream(nsIOutputStream *outStream)
= 0;</tt>
<p><tt>&nbsp;&nbsp;&nbsp; //</tt>
<br><tt>&nbsp;&nbsp;&nbsp; // The output listener can be set to allow for
the flexibility of having the stream converter</tt>
<br><tt>&nbsp;&nbsp;&nbsp; // directly notify the listener of the output
stream for any processed/converter data. If</tt>
<br><tt>&nbsp;&nbsp;&nbsp; // this output listener is not set, the data
will be written into the output stream but it is</tt>
<br><tt>&nbsp;&nbsp;&nbsp; // the responsibility of the client of the stream
converter to handle the resulting data.</tt>
<br><tt>&nbsp;&nbsp;&nbsp; //</tt>
<br><tt>&nbsp;&nbsp;&nbsp; NS_IMETHOD SetOutputListener(nsIStreamListener
*outListner) = 0;</tt>
<br><tt>};</tt>
<p><tt>#endif /* nsIStreamConverter_h_ */</tt>
<br>&nbsp;
<br>&nbsp;
<table COLS=1 WIDTH="100%" BGCOLOR="#FFCC99" >
<tr>
<td>
<center><b><font face="Arial,Helvetica">nsRFC822toHTMLStreamConverter.h</font></b></center>
</td>
</tr>
</table>

<p><tt>#ifndef nsRFC822toHTMLStreamConverter_h_</tt>
<br><tt>#define nsRFC822toHTMLStreamConverter_h_</tt>
<p><tt>#include "nsIStreamConverter.h"</tt>
<p><tt>//</tt>
<br><tt>// A specific stream converter will be specified for each format-in/format-out</tt>
<br><tt>// pairing.</tt>
<br><tt>//</tt>
<p><tt>// {22DB1685-AA68-11d2-8809-00805F5A1FB8}</tt>
<br><tt>#define NS_RFC822_HTML_STREAM_CONVERTER_CID \</tt>
<br><tt>&nbsp; { 0x22db1685, 0xaa68, 0x11d2, \</tt>
<br><tt>&nbsp; { 0x88, 0x9, 0x0, 0x80, 0x5f, 0x5a, 0x1f, 0xb8 } };</tt>
<p><tt>class nsRFC822toHTMLStreamConverter : public nsIStreamConverter
{</tt>
<br><tt>public:</tt>
<br><tt>&nbsp;&nbsp;&nbsp; void *tagData;</tt>
<br><tt>};</tt>
<p><tt>#endif /* nsRFC822toHTMLStreamConverter_h_ */</tt>
<br>&nbsp;




</TD>


<TD VALIGN=TOP ALIGN=RIGHT>
</TD>


<TD BGCOLOR="#000000" VALIGN=TOP><IMG ALT=""
SRC="../images/bit.gif"
WIDTH=4 HEIGHT=16 HSPACE=0 VSPACE=0></TD>

</TR>


<TR>


<TD BGCOLOR="#000000" VALIGN=BOTTOM ALIGN=RIGHT><IMG ALT=""
SRC="../images/bit.gif"
WIDTH=4 HEIGHT=16 HSPACE=0 VSPACE=0></TD>

<TD BGCOLOR="#DDDDDD" VALIGN=BOTTOM><IMG ALT=""
SRC="../images/curve2.gif"
WIDTH=16 HEIGHT=16 HSPACE=0 VSPACE=0></TD>

<TD BGCOLOR="#DDDDDD" VALIGN=BOTTOM ALIGN=RIGHT><IMG ALT=""
SRC="../images/curve4.gif"
WIDTH=16 HEIGHT=16 HSPACE=0 VSPACE=0></TD>

<TD BGCOLOR="#000000" VALIGN=BOTTOM><IMG ALT=""
SRC="../images/bit.gif"
WIDTH=4 HEIGHT=16 HSPACE=0 VSPACE=0></TD>


<TD VALIGN=BOTTOM COLSPAN=2><IMG ALT=""
SRC="../images/curve2.gif"
WIDTH=16 HEIGHT=16 HSPACE=0 VSPACE=0></TD>

<TD VALIGN=BOTTOM ALIGN=RIGHT><IMG ALT=""
SRC="../images/curve4.gif"
WIDTH=16 HEIGHT=16 HSPACE=0 VSPACE=0></TD>

<TD BGCOLOR="#000000" VALIGN=BOTTOM ALIGN=RIGHT><IMG ALT=""
SRC="../images/bit.gif"
WIDTH=4 HEIGHT=16 HSPACE=0 VSPACE=0></TD>
</TR>

<TR BGCOLOR="#000000">

<TD BGCOLOR="#000000" COLSPAN=5><BR></TD>

<TD BGCOLOR="#000000" VALIGN=TOP>

<FONT COLOR="#AAAAAA" SIZE="-1">
Copyright &copy; 1998-1999 The Mozilla Organization.
</FONT>

</TD>

<TD BGCOLOR="#000000" COLSPAN=2><BR></TD>
</TR>

</TABLE>
</BODY>
</HTML>
