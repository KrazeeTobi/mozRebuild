<HTML>
<HEAD>
<TITLE>mozilla.org</TITLE>
</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000"
LINK="#0000EE" VLINK="#551A8B" ALINK="#FF0000"
MARGINHEIGHT=0 MARGINWIDTH=0>

<MAP NAME="banner">
<AREA SHAPE=RECT COORDS="300,11,558,44" HREF="http://www.mozilla.org/">
</MAP>

<TABLE BORDER=0 CELLPADDING=0 CELLSPACING=0 WIDTH="100%">
<TR><TD BGCOLOR="#000000" VALIGN=TOP ROWSPAN=2><IMG
SRC="../../images/mozilla-banner.gif"
ALT="" BORDER=0 USEMAP="#banner"
WIDTH=600 HEIGHT=58 VSPACE=0 HSPACE=0></TD></TR></TABLE>
<TABLE BORDER=0 CELLPADDING=0 CELLSPACING=0 WIDTH="100%">
<TR>


<TD BGCOLOR="#000000" VALIGN=TOP ALIGN=RIGHT><IMG ALT=""
SRC="../../images/bit.gif"
WIDTH=4 HEIGHT=16 HSPACE=0 VSPACE=0></TD>

<TD BGCOLOR="#DDDDDD" VALIGN=TOP><IMG ALT=""
SRC="../../images/curve1.gif"
WIDTH=16 HEIGHT=16 HSPACE=0 VSPACE=0></TD>


<TD BGCOLOR="#DDDDDD" VALIGN=TOP ROWSPAN=2>

<BR><TABLE CELLPADDING=0 CELLSPACING=3 BORDER=0>
<TR><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=19><A HREF="../..//"><B> The Mozilla<BR>Organization</B></A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../../mission.html"> Our Mission</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../../about.html"> Who We Are</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../../get-involved.html"> Getting Involved</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../../community.html"> Community</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../../advocacy.html"> Editorials</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../../news.html"> What's New</A></TD></TR>
<TR><TD NOWRAP VALIGN=TOP COLSPAN=20><B></B></TD></TR>
<TR><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=19><A HREF="../../development.html"><B> Development</B></A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../../roadmap.html"> Roadmap</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../../owners.html"> Module Owners</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../../blue-sky/"> Blue Sky</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../../projects.html"> Projects</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../../status/"> Status</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../../tools.html"> Tools</A></TD></TR>
<TR><TD NOWRAP VALIGN=TOP COLSPAN=20><B></B></TD></TR>
<TR><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=19><A HREF="../../products.html"><B> Products</B></A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../../source.html"> Source Code</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../../binaries.html"> Binaries</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../../docs/"> Documentation</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../../NPL/"> License Terms</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../../bugs/"> Bug Reports</A></TD></TR>
<TR><TD NOWRAP VALIGN=TOP COLSPAN=20><B></B></TD></TR>
<TR><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=19><A HREF="../../search.html"><B> Search</B></A></TD></TR>
<TR><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=19><A HREF="../../feedback.html"><B> Feedback</B></A></TD></TR>
</TABLE><BR>

</TD>


<TD BGCOLOR="#DDDDDD" VALIGN=TOP ALIGN=RIGHT><IMG ALT=""
SRC="../../images/curve3.gif"
WIDTH=16 HEIGHT=16 HSPACE=0 VSPACE=0></TD>

<TD BGCOLOR="#000000" VALIGN=TOP><IMG ALT=""
SRC="../../images/bit.gif"
WIDTH=4 HEIGHT=16 HSPACE=0 VSPACE=0></TD>

<TD VALIGN=TOP><IMG ALT=""
SRC="../../images/curve1.gif"
WIDTH=16 HEIGHT=16 HSPACE=0 VSPACE=0></TD>


<TD VALIGN=TOP ROWSPAN=2>
<P><BR>


<table BORDER=0 WIDTH="75%" BGCOLOR="#FFCCCC" >
<tr>
<td><b><font>The New nsString Class Implementation</font></b>
<br>Author: <a href="mailto:rickg@netscape.com">Rick
Gessner</a></td>
</tr>
</table>

<p>This document is intended to briefly
describe the new nsString class architecture, and discuss the implications
on memory management, optimizations, internationalization and usage patterns.
<p>Disclaimer: I absolutely hate string
classes. No one has ever devised one that more than 2 programmers can agree
on. So, why then am I proposing this? Well, nsString has served us well
so far, but it's in need of a facelift. And XPCOM has really taken off,
so nsString needs to be brought into alignment.
<br>
<table BORDER=0 WIDTH="75%" BGCOLOR="#FFCCCC" >
<tr>
<td><b>Justification</b></td>
</tr>
</table>

<p>The nsString class is a wide character
string class used throughout all of Gecko (and other modules) as the default
implementation. However, it suffers from a few implementation details which
need to be addressed and that are the subject of this document. The deficiencies
of the current implementation are:
<ol>
<li>
Class based -- making it unsuitable
for cross-dll usage due to fragility</li>

<li>
Little intrinsic i18n support</li>

<li>
Few efficiencies, notably a lack of
support for narrow (1-byte) character strings</li>

<li>
No support for external memory management
policy</li>

<li>
Lack of XPCOM interface</li>
</ol>
Notable features of the new nsStrImpl
implementation are:
<ol>
<li>
Intrinsic support for 1 and 2 byte character
widths</li>

<li>
Provides automatic conversion between
strings with different character sizes</li>

<li>
Inviolate base structure eliminates
class fragility problem; safe across DLL boundaries</li>

<li>
Offers C-style function API to manipulate
nsStrImpl</li>

<li>
Offers simple memory allocator API for
specialized memory policy</li>

<li>
Shares binary format with BString</li>

<li>
Coming soon: a new XPCOM (nsIString)
interface</li>

<li>
Non-templatized; this is a requirement
for Gecko</li>

<li>
Very efficient buffer manipulation</li>
</ol>

<table BORDER=0 WIDTH="75%" BGCOLOR="#FFCCCC" >
<tr>
<td><b>Architecture</b></td>
</tr>
</table>

<p>The fundamental datatype in the new
architecture is nsStrImpl struct, given below:
<pre><tt>struct nsStrImpl {
&nbsp; PRInt32 mLength;
&nbsp; void*&nbsp;&nbsp; mBuffer;
&nbsp; PRInt32 mCapacity;
&nbsp; char&nbsp;&nbsp;&nbsp; mCharSize;
&nbsp; char&nbsp;&nbsp;&nbsp; mUnused;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#3366FF">//and now for the nsStrImpl API...
</font>&nbsp; static void EnsureCapacity(nsStrImpl&amp; aString,PRUint32 aNewLength);
&nbsp; static void GrowCapacity(nsStrImpl&amp; aString,PRUint32 aNewLength);

&nbsp; static void Append(nsStrImpl&amp; aDest,const nsStrImpl&amp; aSource,PRUint32 anOffset,PRInt32 aCount);
&nbsp; static void AppendCString(nsStrImpl&amp; aDest,const char* aSource,PRUint32 anOffset,PRInt32 aCount);

&nbsp; static void Assign(nsStrImpl&amp; aDest,const nsStrImpl&amp; aSource,PRUint32 anOffset,PRInt32 aCount);
&nbsp; static void AssignCString(nsStrImpl&amp; aDest,const char* aSource,PRUint32 anOffset,PRInt32 aCount);
&nbsp;&nbsp;
&nbsp; // assign a char or a substring into the existing string...

&nbsp; static void Insert(nsStrImpl&amp; aDest,PRUint32 aDestOffset,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const nsStrImpl&amp; aSource,PRUint32 aSrcOffset,PRInt32 aCount);

&nbsp; static void InsertCString(nsStrImpl&amp; aDest,PRUint32 aDestOffset,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const char* aSource,PRUint32 aSrcOffset,PRInt32 aCount);

&nbsp; static void InsertChar(nsStrImpl&amp; aDest,PRUint32 aDestOffset,char theChar);
&nbsp; static void InsertChar(nsStrImpl&amp; aDest,PRUint32 aDestOffset,PRUnichar theUnichar);
&nbsp; static void InsertChar(nsStrImpl&amp; aDest,PRUint32 aDestOffset,PRInt32 theQuadChar);

&nbsp; static void Delete(nsStrImpl&amp; aDest,PRUint32 aDestOffset,PRUint32 aCount);
&nbsp; static void Truncate(nsStrImpl&amp; aDest,PRUint32 aDestOffset);

&nbsp; static PRInt32 Compare(const nsStrImpl&amp; aDest,const nsStrImpl&amp; aSource,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PRInt32 aCount,PRBool aIgnoreCase);
};</tt></pre>
<b>nsString</b>
<p>The nsString class is still with
us as a subclass (wrapper) of nsStrImpl. By default, nsStrings use a 2-byte
UCS2 character storage model. The nsString class is very lightweight since
it gets its functionality from the nsStrImpl static library. In addition
to the nsStrImpl API shown above, nsString, nsAutoString and nsCString
all offer additional API's (that all degrade to those found in nsStrImpl)
for construction, searching and comparison. Also note that the new nsString
interface mimics fully the interface in the existing nsString class found
in mozilla/base/src/nsString.h.
<p><b>nsAutoString</b>
<p>We still offer an nsAutoString that
provides its own stack based buffer. This very useful class allows programmers
to take advantage of the nsString/nsStrImpl implementation, while eliminating
heap based allocations. An additional improvement has been made to nsAutoString
that allows it to use an arbitrarily sized stack based buffer rather than
its own internal buffer. This means that you can continue to use efficient
(temporary) stack buffers for string storage with the bonus of storage
pools that serve your specific need. (Sounds complicated, but it's really
easy). This class fully interoperates with nsString and nsStrImpl.
<p><b>nsCString</b>
<p>The new nsCString class shares the
same API with nsString, but uses a 1-byte ASCII character storage model.
This will allow programmers to use the nsString API's like a standard char*
without incurring the 2-byte per character overhead. This class fully interoperates
with nsString, nsAutoString and nsStrImpl.
<p><b>nsIString</b>
<p>Naturally we will need include an
nsIString interface onto the nsStrImpl/nsString classes. I won't repeat
it's interface here since it is basically a restatement (in XPCOM terms)
of the nsString interface.
<br>
<table BORDER=0 WIDTH="75%" BGCOLOR="#FFCCCC" >
<tr>
<td><b>Usage Patterns</b></td>
</tr>
</table>

<p><b>How To Use These Classes</b>
<p>To increase the portability, thread
and process safety of Gecko, I suggest the following rules regarding the
use of each of our string class derivatives:
<br>
<table BORDER WIDTH="75%" >
<tr BGCOLOR="#EEEEEE">
<td WIDTH="34%">
<center>String Class</center>
</td>

<td WIDTH="66%">
<center>Where To Use</center>
</td>
</tr>

<tr>
<td WIDTH="34%">nsStrImpl</td>

<td WIDTH="66%">Use to pass strings
between modules who have linked the nsStrImpl function library.</td>
</tr>

<tr>
<td WIDTH="34%">nsString</td>

<td WIDTH="66%">Use these locally in
objects who span of control is known to live within your own process. These
should typically not be exposed to objects in other modules.</td>
</tr>

<tr>
<td WIDTH="34%">nsAutoString</td>

<td WIDTH="66%">Use these locally in
cases where you don't want to incur heap allocation unless absolutely necessary.</td>
</tr>

<tr>
<td WIDTH="34%">nsCString</td>

<td WIDTH="66%">Same as nsString, but
should be used with caution because of localization concerns.</td>
</tr>

<tr>
<td WIDTH="34%">nsIString</td>

<td WIDTH="66%">Use to pass strings
between modules that may not use nsStrImpl implementation. This is the
most generic approach, but offers reference counted strings.</td>
</tr>
</table>

<p>There are implications regarding
this implementation, notably dealing with API changes throughout Gecko.
Notably, nsStrings in API's will be discouraged in <i>public</i> API's.
These API's will need to be rewritten using nsStrImpl references instead.
As an alternative, programmers can pass nsIStrings between modules.
<p><b>I18n Issues</b>
<p>Another concern (mainly of the i18n
team) has to do with the use of a 1-byte (ASCII) nsCString <i>at all.</i>
The i18n team correctly points out that that anarchy will prevail if judicious
control over their use is not mandated. The problem stems from assumptions
that programmers make regarding ASCII strings; the typical assumption being
that they will never need to interoperate with code that assumes UCS2 strings.
This assumption is nearly always wrong -- and will seriously hinder our
ability to localize the source base.
<p>It is recognized that (ASCII) nsCString's
are useful in the following contexts:
<ol>
<li>
Whenever calling libraries that expect
a char* variant</li>

<li>
Whenever maximum memory efficiency is
essential</li>
</ol>
I would argue that only the first case
is normatively legitimate. The i18n folks will tell you it's better to
use a wide string and convert to 1-byte forms for this purpose even though
there is a performance penalty for doing so. Since I have to acknowledge
the idiom, I have made nsCString available but note that it should be used
sparingly.
<br>
<table BORDER=0 WIDTH="75%" BGCOLOR="#FFCCCC" >
<tr>
<td><b>Memory Management</b></td>
</tr>
</table>

<p>A principal enhancement of the new
architecture is pluggable memory allocators. All nsString subclasses provide
their own default allocator implementations, but programmers are free to
use their own. In the new prototype nsStrImpl and nsString classes, the
allocator is an intrinsic member installed during construction of the string
(by default they share a global allocator).
<p>Note: The COM rules imply that everyone
needs to use the same allocators, that they acquire via a global COM service
called CoGetMalloc(). Our nsStrImpl uses an allocator pattern so that programmers
can install their own policy, but this may also make allocation simpler
in a multiprocess environment. I'm wondering if this is sufficient, namely,
that a string can return it's own (shared) allocator for this purpose.
<p>Our minimalistic nsIMemoryAgent interface
is just rich enough to support the nsString idiom, and could be extended
to serve as the general memory allocation idiom. Here's it's API:
<pre><tt>class nsIMemoryAgent : nsISupports {
&nbsp; void* New(nsInt32 aSize)=0;&nbsp;&nbsp; //used for both alloc and realloc
&nbsp; void* Delete(void* aPtr)=0;&nbsp;
};</tt></pre>

<table BORDER=0 WIDTH="75%" BGCOLOR="#FFCCCC" >
<tr>
<td><b>Internationalization</b></td>
</tr>
</table>

<p>The new nsStrImpl/nsString implementation
addresses at least two of the primary concerns of our i18n team. First,
nsStrImpl offers charset conversion hooks for use during construction,
comparison and assignment. (These are stubbed out today awaiting their
review and implementation). Second, they are concerned that programmers
be prevented from abusing the string classes in a number of ways. To wit:
<ol>
<li>
They want to ensure that the underlying
buffers cannot be corrupted or altered erroneously</li>

<li>
They want to ensure that the appropriate
set of conversion functions get applied</li>

<li>
They want some control over the usage
pattern of strings, such that the 2-byte (UCS2) form is used whenever possible,
and some restrictions are applied to the use of 1-byte (ASCII) nsCStrings.</li>
</ol>




<P><BR>
</TD>


<TD VALIGN=TOP ALIGN=RIGHT><IMG ALT=""
SRC="../../images/curve3.gif"
WIDTH=16 HEIGHT=16 HSPACE=0 VSPACE=0></TD>

<TD BGCOLOR="#000000" VALIGN=TOP><IMG ALT=""
SRC="../../images/bit.gif"
WIDTH=4 HEIGHT=16 HSPACE=0 VSPACE=0></TD>

</TR>
<TR>


<TD BGCOLOR="#000000" VALIGN=BOTTOM ALIGN=RIGHT><IMG ALT=""
SRC="../../images/bit.gif"
WIDTH=4 HEIGHT=16 HSPACE=0 VSPACE=0></TD>

<TD BGCOLOR="#DDDDDD" VALIGN=BOTTOM><IMG ALT=""
SRC="../../images/curve2.gif"
WIDTH=16 HEIGHT=16 HSPACE=0 VSPACE=0></TD>

<TD BGCOLOR="#DDDDDD" VALIGN=BOTTOM ALIGN=RIGHT><IMG ALT=""
SRC="../../images/curve4.gif"
WIDTH=16 HEIGHT=16 HSPACE=0 VSPACE=0></TD>

<TD BGCOLOR="#000000" VALIGN=BOTTOM><IMG ALT=""
SRC="../../images/bit.gif"
WIDTH=4 HEIGHT=16 HSPACE=0 VSPACE=0></TD>

<TD VALIGN=BOTTOM><IMG ALT=""
SRC="../../images/curve2.gif"
WIDTH=16 HEIGHT=16 HSPACE=0 VSPACE=0></TD>


<TD VALIGN=BOTTOM ALIGN=RIGHT><IMG ALT=""
SRC="../../images/curve4.gif"
WIDTH=16 HEIGHT=16 HSPACE=0 VSPACE=0></TD>

<TD BGCOLOR="#000000" VALIGN=BOTTOM ALIGN=RIGHT><IMG ALT=""
SRC="../../images/bit.gif"
WIDTH=4 HEIGHT=16 HSPACE=0 VSPACE=0></TD>
</TR>

<TR>

<TD BGCOLOR="#000000" COLSPAN=6><BR></TD>

<TD BGCOLOR="#000000" VALIGN=TOP>

<FONT COLOR="#AAAAAA" SIZE="-1">
Copyright &copy; 1998 The Mozilla Organization.
</FONT>

</TD>

<TD BGCOLOR="#000000" COLSPAN=2><BR></TD>
</TR>

</TABLE>
<P>
</BODY>
</HTML>
