<HTML>
<HEAD>
   <META NAME="GENERATOR" CONTENT="Mozilla/4.04 [en] (X11; I; IRIX 6.2 IP22) [Netscape]">
   <META NAME="Author" CONTENT="Wan-Teh Chang">
   <TITLE>Building NSPR</TITLE>
</HEAD>
<BODY TEXT="#000000" BGCOLOR="#FFFFFF" LINK="#0000EE" VLINK="#551A8B" ALINK="#FF0000">

<H1>
Building NSPR</H1>

<ADDRESS>
Last updated 3/5/98</ADDRESS>


<P>NSPR has been implemented on over 20 platforms.  A platform may
have more than one implementation strategy of its multithreading and I/O
facilities.  This article explains the NSPR build system and how to
specify a particular implementation strategy, compiler or compiler switches,
or the target OS for your build on each platform.
<H2>
Implementation Strategies</H2>
Threads are at the core of NSPR, and the I/O functions are tied to the
multithreading facilities because many I/O functions may block the calling
threads.  NSPR has multiple implementation strategies of its multithreading
and I/O functions.  The various implementation strategies can be organized
into the hierarchy below:
<UL>
<LI>
<B>Classic NSPR </B>(This is our first code base, hence the term "classic
NSPR"):</LI>
</UL>

<UL>
<UL>
<LI>
<B>Local threads only</B>: All threads are user-level threads implemented
by NSPR.</LI>

<LI>
<B>Global threads only</B>: All threads are native threads supplied by
the OS vendor.  For example, Solaris UI (Unix International) threads
and Win32 threads.</LI>

<LI>
<B>Combined</B>: NSPR multiplexes user-level threads on top of native,
kernel-level threads.  This is also called the MxN model.  At
present, there are three implementations of the combined model.</LI>

<UL>
<LI>
IRIX: sprocs +  NSPR user-level threads</LI>

<LI>
Windows NT: Win32 threads + NT fibers</LI>

<LI>
<B>Pthreads-user</B>: kernel-level pthreads + NSPR user-level threads</LI>
</UL>
</UL>

<LI>
<B>Pthreads</B>: All threads are pthreads. The relevant code is in <TT>ns/nspr20/pr/src/pthreads</TT>
(threads and I/O).</LI>
</UL>
Classic NSPR and pthreads have relatively disjoint code bases in the threads
and I/O areas:
<UL>
<LI>
Classic NSPR: <TT>ns/nspr20/pr/src/threads/combined</TT> (threads), <TT>ns/nspr20/pr/src/io</TT>
(I/O)</LI>

<LI>
Pthreads: <TT>ns/nspr20/pr/src/pthreads</TT> (threads and I/O)</LI>
</UL>
Note that some files under <TT>ns/nspr20/pr/src/io</TT> are shared by both
classic NSPR and pthreads.  Consult <TT>ns/nspr20/pr/src/Makefile</TT>
for the definitive list of files used by each implementation strategy (see
the definition of the makefile variable <TT>OBJS</TT>).
<H2>
Compilers</H2>
For ease of integration with third-party libraries, which may use native
threads, NSPR uses the native threads whenever possible.  As a result,
native compilers are used to build NSPR on most platforms because they
have better debugging support for native threads.  The only exception
is Solaris, where both cc and gcc are used.
<H2>
NSPR Build System</H2>
On Unix and Win32, NSPR build system is based on GNU make.  (GNU make
can be obtained by anonymous ftp from <TT><A HREF="ftp://prep.ai.mit.edu/pub/gnu/">ftp://prep.ai.mit.edu/pub/gnu/</A></TT>.)
On Mac, NSPR uses Metrowerk's CodeWarrior Mac project files.

<P>Inside Netscape, we use GNU make 3.74 on Unix, but our makefiles should
work fine under newer versions of GNU make.  On Win32, we use an internal
Win32 port of GNU make 3.74 and a homegrown stripped-down version of Bourne
shell called <TT>shmsdos.exe</TT>.  Our own Win32 port of GNU make
and <TT>shmsdos.exe</TT> are distributed with the NSPR source.  Our
makefiles also work under the official Win32 port of GNU make (3.75 and
above) and the Korn shell <TT>sh.exe</TT> in MKS Toolkit.

<P>Every directory in NSPR has a makefile named <TT>Makefile</TT>, which
includes the makefile fragments in <TT>ns/nspr20/config</TT>.  NSPR
makefiles implement the common Netscape makefile targets such as <TT>export</TT>,
<TT>libs</TT>, and <TT>install</TT>.  However, some makefiles targets
are no-op in NSPR because they are not necessary for NSPR.

<P>To build NSPR, change directory to the root of our source tree

<PRE>    cd ns/nspr20</PRE>

<P>and then issue the command

<PRE>    gmake</PRE>

<P>Make will recursively go into all the subdirectories and the right
things will happen.

<P>The table below lists the common NSPR makefile targets..
<BR>
<TABLE BORDER COLS=2 WIDTH="100%" >
<TR>
<TD><TT>all</TT></TD>

<TD>The default target.  Same as <TT>export</TT> <TT>libs</TT> <TT>install</TT>.</TD>
</TR>

<TR>
<TD><TT>export</TT></TD>

<TD>Do a complete build.</TD>
</TR>

<TR>
<TD><TT>libs</TT></TD>

<TD>No-op.</TD>
</TR>

<TR>
<TD><TT>install</TT></TD>

<TD>No-op.</TD>
</TR>

<TR>
<TD><TT>depend</TT></TD>

<TD>No-op. <B>This means that NSPR makefiles do not have header file dependencies.</B></TD>
</TR>

<TR>
<TD><TT>clean</TT></TD>

<TD>Remove <TT>.o</TT> files.</TD>
</TR>

<TR>
<TD><TT>clobber</TT></TD>

<TD>Remove <TT>.o</TT> files, libraries, and executable programs.</TD>
</TR>

<TR>
<TD><TT>realclean</TT></TD>

<TD>Remove all generated files and directories.</TD>
</TR>

<TR>
<TD><TT>clobber_all</TT></TD>

<TD>Same as <TT>realclean</TT>.</TD>
</TR>
</TABLE>
The table below lists common makefile variables that one can specify on
the command line to customize a build..
<BR>
<TABLE BORDER COLS=2 WIDTH="100%" >
<TR>
<TD><TT>BUILD_OPT</TT></TD>

<TD>Optimized build (default: debug build).</TD>
</TR>

<TR>
<TD><TT>OS_TARGET</TT></TD>

<TD>Set to the target OS (<TT>WIN95</TT> or <TT>WIN16</TT>) when doing
cross-compilation on NT (default: same as the host OS).</TD>
</TR>

<TR>
<TD><TT>NS_USE_GCC</TT></TD>

<TD>Use gcc and g++ (default: native compilers).</TD>
</TR>

<TR>
<TD><TT>USE_PTHREADS</TT></TD>

<TD>Build pthreads version.</TD>
</TR>

<TR>
<TD><TT>CLASSIC_NSPR</TT></TD>

<TD>Build classic NSPR version (usually local threads only).</TD>
</TR>

<TR>
<TD><TT>PTHREADS_USER</TT></TD>

<TD>Build pthreads-user version.</TD>
</TR>

<TR>
<TD><TT>LOCAL_THREADS_ONLY</TT></TD>

<TD>Build local threads only version.</TD>
</TR>

<TR>
<TD><TT>USE_DEBUG_RTL</TT></TD>

<TD>On Win32, compile with <TT>/MDd</TT> in the debug build (default: <TT>/MD</TT>).
Optimized build always uses <TT>/MD</TT>.</TD>
</TR>

<TR>
<TD><TT>USE_N32</TT></TD>

<TD>On IRIX, compile with <TT>-n32</TT> (default: <TT>-32</TT>).</TD>
</TR>

<TR>
<TD><TT>USE_IPV6</TT></TD>

<TD>Enable IPv6.</TD>
</TR>

<TR>
<TD><TT>MOZILLA_CLIENT</TT></TD>

<TD>Adjust NSPR build system for Netscape Client (mozilla).</TD>
</TR>
</TABLE>

<H2>
Platforms</H2>
Platforms supported by NSPR can be divided into three categories: Unix,
Windows, and Mac.  At present, NSPR aims to support Netscape Communicator
5.0 and Server Suitespot 4.0.  The platforms on which we build our
binary releases are listed below.
<H3>
Unix</H3>
AIX:  4.2.1
<UL>The default implementation strategy is pthreads. Local threads only
and pthreads-user versions are also available.  To build the local
threads only version, use the command
<PRE>    gmake CLASSIC_NSPR=1</PRE>
<P>To build the pthreads-user version, use the command
<PRE>    gmake PTHREADS_USER=1</PRE></UL>
BSD/386: 3.0, 2.1
<UL>The default implementation strategy is local threads only.</UL>
Digital Unix: V4.0B
<UL>The default implementation strategy is pthreads. To build the local
threads only version, use the command
<PRE>    gmake CLASSIC_NSPR=1</PRE></UL>
FreeBSD: 2.2
<UL>The default implementation strategy is local threads only.</UL>
HP-UX: B.10.10
<UL>The default implementation strategy is pthreads, or rather DCE threads
(Posix thread draft 4).  To build the local threads only version,
use the command
<PRE>    gmake CLASSIC_NSPR=1</PRE></UL>
HP-UX: B.11.00
<UL>The default implementation strategy is pthreads. Local threads only
and pthreads-user versions are also available. To build the local threads
only version, use the command
<PRE>    gmake CLASSIC_NSPR=1</TT>
<P>To build the pthreads-user version, use the command
<PRE>    gmake PTHREADS_USER=1</PRE></UL>
Irix: 6.2
<UL>The default implementation strategy is combined (MxN).  A global
thread is mapped to an Irix sproc.  Local threads are implemented
using user-level context switching in NSPR.  The primordial thread,
which executes the <TT>main()</TT> function, is a local thread.
<BR>The pthreads version is also available.  To build the pthreads
version, use the command
<PRE>    gmake USE_PTHREADS=1</PRE></UL>
Linux: 2.0
<UL>The default implementation strategy is local threads only.  The
pthreads version, based on LinuxThreads,  is mostly working.
To build the pthreads version, use the command
<PRE>    gmake USE_PTHREADS=1</PRE></UL>
MkLinux/PPC: 2.0
<UL>The default implementation strategy is local threads only.</UL>
NCR: 3.0
<UL>The default implementation strategy is local threads only.</UL>
NEC: 4.2
<UL>The default implementation strategy is local threads only.</UL>
SCO_SV: 3.2
<UL>The default implementation strategy is local threads only.</UL>
SINIX: 5.42
<UL>The default implementation strategy is local threads only.</UL>
Solaris: 2.5.1 sparc, 2.5.1 x86
<UL>The default implementation strategy is global threads only, in which
every NSPR thread is mapped to a native Solaris UI thread.  Local
threads only and pthreads versions are also available.  To build the
local threads only version, use the command
<PRE>    gmake LOCAL_THREADS_ONLY=1</TT>
<P>To build the pthreads version, use the command
<PRE>    gmake USE_PTHREADS=1</TT>
<P>To build with gcc and g++, use the command
<PRE>    gmake NS_USE_GCC=1</PRE></UL>
SunOS 4: 4.1.3_U1
<UL>The default implementation strategy is local threads only.</UL>
UNIXWARE: 2.1
<UL>The default implementation strategy is local threads only.</UL>

<H3>
Windows</H3>
Windows NT: 3.51, 4.0
<UL>The default implementation strategy is combined (MxN).  A global
thread is mapped to a Win32 native thread.  A local thread is an NT
fiber.  The primordial thread, which executes main(), is a local thread.

<P>NSPR20 requires NT 3.51 Service Pack 5 or NT 4.0 Service Pack 3.
The service packs can be downloaded from Microsoft's ftp site at <A HREF="ftp://ftp.microsoft.com/bussys/winnt/winnt-public/fixes/usa">ftp://ftp.microsoft.com/bussys/winnt/winnt-public/fixes/usa</A>.</UL>
Windows 95
<UL>The default implementation strategy is global threads only.  Note
that the Windows 95 binary is the generic Win32 binary that runs on both
Windows 95 and NT.
<BR>Windows 95 version of NSPR can be built on an NT machine with the command
<PRE>    gmake OS_TARGET=WIN95</PRE></UL>
Windows 3.1 (16-bit Windows)
<UL>The default implementation strategy is local threads only.  Windows
3.1 version of NSPR can be built on an NT machine with the command
<PRE>    gmake OS_TARGET=WIN16</PRE></UL>

<H3>
Mac</H3>

<UL>The default implementation strategy is local threads only.</UL>

<DIV ALIGN=right><BR>
<BR>

<HR WIDTH="100%"></DIV>

<DIV ALIGN=right><I><FONT SIZE=-1>Last updated: Tue Mar 10 09:44:49 PST
1998</FONT></I></DIV>

<HR WIDTH="100%">
<CENTER>Copyright &copy; 1998 <A HREF="http://home.netscape.com/misc/contact_info.html">Netscape
Communications Corporation</A></CENTER>

</BODY>
</HTML>
