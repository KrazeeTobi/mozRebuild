<HTML>
<HEAD>
<TITLE>New Layout: Rendering</TITLE>
</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000"
LINK="#0000EE" VLINK="#551A8B" ALINK="#FF0000"
MARGINHEIGHT=0 MARGINWIDTH=0>

<MAP NAME="banner">
<AREA SHAPE=RECT COORDS="300,11,558,44" HREF="http://www.mozilla.org/">
</MAP>

<TABLE BORDER=0 CELLPADDING=0 CELLSPACING=0 WIDTH="100%">
<TR><TD BGCOLOR="#000000" VALIGN=TOP ROWSPAN=2><IMG
SRC="../../images/mozilla-banner.gif"
ALT="" BORDER=0 USEMAP="#banner"
WIDTH=600 HEIGHT=58 VSPACE=0 HSPACE=0></TD></TR></TABLE>
<TABLE BORDER=0 CELLPADDING=0 CELLSPACING=0 WIDTH="100%">
<TR>


<TD BGCOLOR="#000000" VALIGN=TOP ALIGN=RIGHT><IMG ALT=""
SRC="../../images/bit.gif"
WIDTH=4 HEIGHT=16 HSPACE=0 VSPACE=0></TD>

<TD BGCOLOR="#DDDDDD" VALIGN=TOP><IMG ALT=""
SRC="../../images/curve1.gif"
WIDTH=16 HEIGHT=16 HSPACE=0 VSPACE=0></TD>


<TD BGCOLOR="#DDDDDD" VALIGN=TOP ROWSPAN=2>

<BR><TABLE CELLPADDING=0 CELLSPACING=3 BORDER=0>
<TR><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=19><A HREF="../..//"><B> The Mozilla<BR>Organization</B></A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../../mission.html"> Our Mission</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../../about.html"> Who We Are</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../../get-involved.html"> Getting Involved</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../../community.html"> Community</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../../advocacy.html"> Editorials</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../../news.html"> What's New</A></TD></TR>
<TR><TD NOWRAP VALIGN=TOP COLSPAN=20><B></B></TD></TR>
<TR><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=19><A HREF="../../development.html"><B> Development</B></A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../../owners.html"> Module Owners</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../../blue-sky/"> Blue Sky</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../../projects.html"> Projects</A></TD></TR>
<TR><TD NOWRAP VALIGN=TOP COLSPAN=20><B></B></TD></TR>
<TR><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=19><A HREF="../../source-code.html"><B> Source Code</B></A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../../source.html"> Getting It</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../../docs/"> Documentation</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../../NPL/"> License Terms</A></TD></TR>
<TR><TD></TD><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=18><A HREF="../../bugs/"> Bugs</A></TD></TR>
<TR><TD NOWRAP VALIGN=TOP COLSPAN=20><B></B></TD></TR>
<TR><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=19><A HREF="../../search"><B> Search</B></A></TD></TR>
<TR><TD VALIGN=TOP><IMG SRC="../../images/bullet1.gif" ALT="" WIDTH=8 HEIGHT=8 HSPACE=2 VSPACE=3></TD><TD NOWRAP COLSPAN=19><A HREF="../../feedback.html"><B> Feedback</B></A></TD></TR>
</TABLE><BR>

</TD>


<TD BGCOLOR="#DDDDDD" VALIGN=TOP ALIGN=RIGHT><IMG ALT=""
SRC="../../images/curve3.gif"
WIDTH=16 HEIGHT=16 HSPACE=0 VSPACE=0></TD>

<TD BGCOLOR="#000000" VALIGN=TOP><IMG ALT=""
SRC="../../images/bit.gif"
WIDTH=4 HEIGHT=16 HSPACE=0 VSPACE=0></TD>

<TD VALIGN=TOP><IMG ALT=""
SRC="../../images/curve1.gif"
WIDTH=16 HEIGHT=16 HSPACE=0 VSPACE=0></TD>


<TD VALIGN=TOP ROWSPAN=2>
<P><BR>






<HR WIDTH="100%"><h2>New Layout: Rendering
</h2>
Author: <a href="mailto:michaelp@netscape.com">Michael 
Plitkins</a> <BR>
Last update: 1May98
<HR WIDTH="100%">
<BR>
<TABLE COLS=1 WIDTH="70%" >
<TR BGCOLOR="#FFFFCC">
<TD><B>Overview</B></TD>
</TR>
</TABLE>
 The graphics subsystem of 
NGLayout is ultimately responsible for displaying "bits" on output devices. This 
includes standard graphical primitives such as lines, rects, bitmaps, text, etc. 
It is not a do-all rendering system. The scope of functionality at this time is 
limited to what ones needs in order to output HTML-like graphics. A more in-depth 
description follows in the sections below. <BR>

<BR>
<TABLE COLS=1 WIDTH="70%" >
<TR BGCOLOR="#FFFFCC">
<TD><B>Major Components</B></TD>
</TR>
</TABLE>
There are basically two separate pieces to the graphics system:

<UL>
<LI>
Platform independent set of structs, classes and interface definitions.
These can be broken down as follows:</LI>

<UL>
<LI>
Geometrical primitive management (rect, point, margin, size, transformation,
etc.)</LI>

<LI>
Color definitions.</LI>

<LI>
Font specification and cache.</LI>

<LI>
Image abstraction.</LI>

<LI>
Interfaces to be implemented per-platform.</LI>

<UL>
<LI>
Rendering Context</LI>

<LI>
Device Context</LI>

<LI>
Font Metrics</LI>

<LI>
Image</LI>
</UL>
</UL>

<LI>
Platform dependent implementation of the per-platform interfaces listed
above.</LI>
</UL>

<TABLE COLS=1 WIDTH="70%" >
<TR BGCOLOR="#FFFFCC">
<TD><B>Implementation</B></TD>
</TR>
</TABLE>
1. Geometrical primitives.
<BLOCKQUOTE>This is a collection of classes to represent 2D objects such
as points, margins, lines, rectangles and sizes. In addition there is a
transformation class that knows how to deal with scale, translation and
matrix concatenation operations. Most classes support operator overloading
to allow math operations to be expressed succinctly.</BLOCKQUOTE>
2. Color definitions.
<BLOCKQUOTE>All colors are defined as RGBA values in the range 0-255 bit
shifted to fit into a 32 bit unsigned word for efficiency. As a result,
a certain amount of type safety is sacrificed. Macros are provided for
packing and unpacking the various color components. There are also a set
of lookup tables to go from named colors to RGBA values.</BLOCKQUOTE>
3. Font specification and cache.
<BLOCKQUOTE>The font struct holds all of the information necessary a particular
typeface. This includes:
<UL>
<LI>
family name</LI>

<LI>
style</LI>

<LI>
variant</LI>

<LI>
weight</LI>

<LI>
decorations</LI>

<LI>
size</LI>
</UL>
The font struct is used in conjunction with the font cache to request a
set of font metrics. The font cache simply holds a list of the various
font metrics that have been requested to date and creates new ones from
fonts when a new font specification is encountered.</BLOCKQUOTE>
4. Image abstraction.
<BLOCKQUOTE>This is a set of interfaces and classes that interact with
the Netscape image library to convert images from URLs to platform independent
image data. To convert to actual bitmaps that can be rendered, the platform
specific image class is necessary.
<UL>
<LI>
An ImageGroup allows a user to manipulate and observe a collection of image
loading requests.</LI>

<LI>
ImageRequests can be manipulated and observed individually.</LI>

<LI>
A user of the image library can provide ImageObservers at either the group
or individual request level.</LI>
</UL>
</BLOCKQUOTE>
5. Rendering Context.
<UL>The rendering context is where all of the other pieces of the graphics
library come together to actually display bits on an ouput device. As such,
the rendering context implementation is unique to each type of output device.
The rendering context, in addition to converting geometrical primitives
to bits, also does state management including:
<BR>
<UL>
<LI>
font</LI>

<LI>
transformation</LI>

<LI>
clip rect</LI>

<LI>
color</LI>

<LI>
state stack</LI>
</UL>


<P>Since the rendering context is the focus point for manipulating bits,
there are additional methods for creating offscreen drawing surfaces and
managing double buffering.</UL>
6. Device Context.
<BR>
<UL>In order to interface with the underlying system's graphics and UI
facilities in a stateless and lightweight XP fashion, the device context
was created. The device context is essentially a set of methods for querying
the system about such things as:
<BR>
<UL>
<LI>
output device resolution in terms of logical units</LI>

<LI>
conversion functions to go from application defined units to device units</LI>

<LI>
display zoom value</LI>
</UL>


<P>A device context is desgined to be shared among all of the higher level
objects that intend to output to the device which the device context describes.
As such, it also owns the font cache since all fonts on the same output
device have the same properties.
<BR></UL>
7. Font Metrics.
<BLOCKQUOTE>Font metrics contain all of the properties of the glyphs of
a typeface. Behind the XP font metrics interface is a platform dependent
implementation that may represent vector based fonts such as Adobe Type
1, True Type, bitmap fonts or anything else that the output device is capable
of rendering. The font metric methods are typically used by things like
layout to perform text measurement.</BLOCKQUOTE>
8. Image.
<BLOCKQUOTE>Bitmaps usually have a very platform specific representation.
The Image class is an encapsulation of the underlying native platform bitmap
structures. Images can be either 8 or 24 bits per pixel on the XP side
of the interface (whatever is closest to the native format) and can have
any representation necessary on the implementation side of the interface.
In addition to holding an array of bytes or triples representing pixel
information, images also have an optional alpha channel and colormap for
8 bpp images. Gamma of the image color information can be queried. Since
some platforms can render bitmaps faster if the bitmap is converted to
an opaque format that only the underlying hardware understands, there are
methods for optimizing a bitmap and querying for optimized status.</BLOCKQUOTE>

<TABLE COLS=1 WIDTH="70%" >
<TR BGCOLOR="#FFFFCC">
<TD><B>Dependencies</B></TD>
</TR>
</TABLE>
Since the graphics system is one of the lowest 
level ones in NGLayout it does not rely on the rest of the codebase for much. 
With that said, it currently has knowledge of the Widget library so that a Rendering 
context can be initialized from the state information contained by a Widget. 
<P>For printed output, the application using 
  the graphics library will be responsible for printer discovery and initialization 
  of a device context with information relevant to the printer that it represents. 
<P>
<TABLE COLS=1 WIDTH="70%" >
<TR BGCOLOR="#FFFFCC">
<TD><B>Roadmap</B></TD>
</TR>
</TABLE>
The highest priority is to get the platform specific code implemented on
Unix and Macintosh. We have a Win32 implementation that, while very functional,
has not yet been optimized.

<P>Colormap support is complete in the Image abstraction code, but has
not yet been fleshed out in the rest of the graphics system. We anticipate
storing the colormap in the Device context since there is a one-to-one
mapping between an output device and a device context. The default colormap
will be a color cube very similar to, if not the same as, that used by
Communicator 4. Applications that wish to modify the color map will essentially
clone the device context and then be responsible for selecting the colormap
in the device into the display when their windows get focus. This will
bascially mean that a Device context represents all output device parameters
including color lookup and that when a different colormap is desired you
are considered to be outputting to a different device. An interface representing
colormap abstraction of platform native colormap structures will be necessary
to achieve this.

<P>We are currently implementing support for alpha blending and per-pixel
image transformations. We have not yet determined where this code will
live once it is all working. The intention is that we will be able to alpha
blend images with alpha channels, and after rendering via the Rendering
context, to be able to blend the output with another Rendering context,
or it's output.

<P>There is a very large hole where printing is supposed to be. This entails
creating a new set of rendering context, device context, font metric and
image objects that know how to deal with printed output. Printer discovery
is a separate issue that will most likely be kept at the application level.

<P>Communicator 4 and previous versions of the Navigator have had downloadable
font technology so that a document can specify a URL for a typeface and
have it downloaded on demand. In addition, special font rasterizers are
necessary for fonts that the native platform does not know how to render.
Similar functionality needs to be added to the graphics system.

<P>While the APIs for document zooming (scaling) are there, very little
is underneath them. Some work needs to be done at the applicaition level
to properly support zooming, and the rest needs to be done in the device
context and font cache.

<P>It would be really great if we could support 
  gamma correction of everything that goes through the rendering pipeline. 
<P><BR>
   
<TABLE COLS=1 WIDTH="70%" >
<TR BGCOLOR="#FFFFCC">
<TD><B>Known Bugs</B></TD>
</TR>
</TABLE>
Support for regions is non-existent.

<P>Font metrics/cache/Font APIs need to allow applications to interate
over the fonts available on the system at runtime to do font matching.

<P>We need to look at issues regarding internationalization including font
encoding, performance and font metric APIs.

<P>There is no support for masked image blits as needed by images such
as "transparent" GIFs.




<P><BR>
</TD>


<TD VALIGN=TOP ALIGN=RIGHT><IMG ALT=""
SRC="../../images/curve3.gif"
WIDTH=16 HEIGHT=16 HSPACE=0 VSPACE=0></TD>

<TD BGCOLOR="#000000" VALIGN=TOP><IMG ALT=""
SRC="../../images/bit.gif"
WIDTH=4 HEIGHT=16 HSPACE=0 VSPACE=0></TD>

</TR>
<TR>


<TD BGCOLOR="#000000" VALIGN=BOTTOM ALIGN=RIGHT><IMG ALT=""
SRC="../../images/bit.gif"
WIDTH=4 HEIGHT=16 HSPACE=0 VSPACE=0></TD>

<TD BGCOLOR="#DDDDDD" VALIGN=BOTTOM><IMG ALT=""
SRC="../../images/curve2.gif"
WIDTH=16 HEIGHT=16 HSPACE=0 VSPACE=0></TD>

<TD BGCOLOR="#DDDDDD" VALIGN=BOTTOM ALIGN=RIGHT><IMG ALT=""
SRC="../../images/curve4.gif"
WIDTH=16 HEIGHT=16 HSPACE=0 VSPACE=0></TD>

<TD BGCOLOR="#000000" VALIGN=BOTTOM><IMG ALT=""
SRC="../../images/bit.gif"
WIDTH=4 HEIGHT=16 HSPACE=0 VSPACE=0></TD>

<TD VALIGN=BOTTOM><IMG ALT=""
SRC="../../images/curve2.gif"
WIDTH=16 HEIGHT=16 HSPACE=0 VSPACE=0></TD>


<TD VALIGN=BOTTOM ALIGN=RIGHT><IMG ALT=""
SRC="../../images/curve4.gif"
WIDTH=16 HEIGHT=16 HSPACE=0 VSPACE=0></TD>

<TD BGCOLOR="#000000" VALIGN=BOTTOM ALIGN=RIGHT><IMG ALT=""
SRC="../../images/bit.gif"
WIDTH=4 HEIGHT=16 HSPACE=0 VSPACE=0></TD>
</TR>

<TR>

<TD BGCOLOR="#000000" COLSPAN=6><BR></TD>

<TD BGCOLOR="#000000" VALIGN=TOP>

<FONT COLOR="#AAAAAA" SIZE="-1">
Copyright &copy; 1998 Netscape Communications Corporation.
</FONT>
</FONT>
</TD>

<TD BGCOLOR="#000000" COLSPAN=2><BR></TD>
</TR>

</TABLE>
<P>
</BODY>
</HTML>
